#include <gmock/gmock.h> // This is the key include for EXPECT_THAT
#include <gtest/gtest.h>

#include "../src/modules/runtime.hpp"
#include "helper.hpp"
namespace {

{% from "macros.j2" import get_signature %}
{% for filename, module in data.items() %}
TEST(Spectest, {{ filename|replace("-", "_")|replace(".", "_") }}) {
  auto wasmModule = helper::loadModule("{{ filename }}");
  auto instance = tiny::ModuleInstance(wasmModule);
  
  {% for function, asserts in module.items() %}
  auto wasm_{{ function|replace("-", "_")|replace(".", "_") }} = instance.getFunction<{{ get_signature(asserts[0].expected, asserts[0].args) }}>("{{ function }}");
  {% endfor %}

  {% for function, asserts in module.items() %}
    {% for assert in asserts %}
      {% if assert.type == "return" %}
        {% if assert.expected|length %}
  EXPECT_EQ(wasm_{{ function|replace("-", "_")|replace(".", "_") }}({{ assert.args|join(', ', attribute='cpp_value') }}), ({{ assert.expected|join(', ', attribute='cpp_value') }}));
        {% else %}
  wasm_{{ function|replace("-", "_")|replace(".", "_") }}({{ assert.args|join(', ', attribute='cpp_value') }});
        {% endif %}
      {% elif assert.type == "trap" %}
  EXPECT_THROW(wasm_{{ function|replace("-", "_")|replace(".", "_") }}({{ assert.args|join(', ', attribute='cpp_value') }}), std::runtime_error);
      {% endif %}
    {% endfor %}
  {% endfor %}
}
{% endfor %}
} // namespace