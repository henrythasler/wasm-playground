#include <gmock/gmock.h> // This is the key include for EXPECT_THAT
#include <gtest/gtest.h>

#include "../src/modules/runtime.hpp"
#include "helper.hpp"
namespace {

{% from "macros.j2" import get_signature %}
{% set var = namespace(filename="") %}
{% for command in data.commands %}
  {% if command.type == 'module' %}
    {% set var.filename = command.filename %}
  {% endif %}
  {% if command.type == 'assert_return' %}
TEST({{ var.filename|replace("-", "_")|replace(".", "_") }}, {{ command.action.field }}_{{ loop.index0 - 1 }}) {
  auto wasmModule = helper::loadModule("{{ var.filename }}");
  auto wasmFunction = tiny::make_wasm_function<{{ get_signature(command.expected, command.action.args) }}>(wasmModule, "{{ command.action.field }}");
  EXPECT_EQ(wasmFunction({{ command.action.args|join(', ', attribute='value') }}), {{ command.expected[0].value }});
}

  {% endif %}
{% endfor %}
} // namespace